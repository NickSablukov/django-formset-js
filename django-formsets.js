// Generated by CoffeeScript 1.12.5
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  this.Formset = (function() {
    function Formset(formset_id, form_prefix1, empty_form_id) {
      this.formset_id = formset_id;
      this.form_prefix = form_prefix1;
      this.empty_form_id = empty_form_id;
      this._rebuildItems = bind(this._rebuildItems, this);
      this.rebuildGroups = bind(this.rebuildGroups, this);
      this.setTotal = bind(this.setTotal, this);
      this.getTotal = bind(this.getTotal, this);
      this.totalInc = bind(this.totalInc, this);
      this.totalDec = bind(this.totalDec, this);
      this.removeGroup = bind(this.removeGroup, this);
      this.addGroup = bind(this.addGroup, this);
    }

    Formset.prototype.addGroup = function() {
      var newForm, total;
      newForm = $("#" + this.empty_form_id).find('.form').clone(true);
      total = this.getTotal();
      newForm.find('input').each(function() {
        var id, name;
        if ($(this).attr('name')) {
          name = $(this).attr('name').replace('__prefix__', total);
          id = 'id_' + name;
          return $(this).attr({
            'name': name,
            'id': id
          });
        }
      });
      newForm.find('select').each(function() {
        var id, name;
        if ($(this).attr('name')) {
          name = $(this).attr('name').replace('__prefix__', total);
          id = 'id_' + name;
          return $(this).attr({
            'name': name,
            'id': id
          });
        }
      });
      newForm.find('label').each(function() {
        var newFor;
        newFor = $(this).attr('for').replace('__prefix__', total);
        return $(this).attr('for', newFor);
      });
      $("#" + this.formset_id).append(newForm);
      this.totalInc();
      return newForm;
    };

    Formset.prototype.removeGroup = function(e) {
      e.remove();
      this.totalDec();
      return this.rebuildGroups();
    };

    Formset.prototype.totalDec = function() {
      var total;
      total = this.getTotal();
      total--;
      return this.setTotal(total);
    };

    Formset.prototype.totalInc = function() {
      var total;
      total = this.getTotal();
      total++;
      return this.setTotal(total);
    };

    Formset.prototype.getTotal = function() {
      return $("#id_" + this.form_prefix + "-TOTAL_FORMS").val();
    };

    Formset.prototype.setTotal = function(total) {
      $("#id_" + this.form_prefix + "-TOTAL_FORMS").val(total);
      return console.log(total, $("#id_" + this.form_prefix + "-TOTAL_FORMS").val());
    };

    Formset.prototype.rebuildGroups = function() {
      var reg;
      reg = new RegExp(this.form_prefix + "-[\\d\\.]+-", 'g');
      return $("#" + this.formset_id).find('.form').each((function(_this) {
        return function(index, e) {
          var elem, form_prefix;
          elem = $(e);
          _this._rebuildItems(elem.find('input'), index);
          _this._rebuildItems(elem.find('select'), index);
          form_prefix = _this.form_prefix;
          return elem.find('label').each(function() {
            var newFor;
            newFor = $(this).attr('for').replace(reg, form_prefix + "-" + index + "-");
            return $(this).attr('for', newFor);
          });
        };
      })(this));
    };

    Formset.prototype._rebuildItems = function(selector, index) {
      var form_prefix, reg;
      reg = new RegExp(this.form_prefix + "-[\\d\\.]+-", 'g');
      form_prefix = this.form_prefix;
      return selector.each(function() {
        var id, name;
        if ($(this).attr('name')) {
          name = $(this).attr('name').replace(reg, form_prefix + "-" + index + "-");
          id = 'id_' + name;
          return $(this).attr({
            'name': name,
            'id': id
          });
        }
      });
    };

    return Formset;

  })();

}).call(this);
